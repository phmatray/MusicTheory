@page "/chords"
@using GuitarChords.Services
@using GuitarChords.Models
@using GuitarChords.Components
@inject GuitarChordService ChordService
@inject ChordProgressionService ProgressionService
@inject ChordPlayerService PlayerService
@inject ISnackbar Snackbar
@implements IDisposable

<PageTitle>Explore Chords</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
    <MudText Typo="Typo.h3" Class="mb-2">Guitar Chord Dictionary</MudText>
    <MudText Typo="Typo.subtitle1" Class="mb-4" Color="Color.Secondary">Explore, learn, and master guitar chords</MudText>

    <ChordFilters @bind-SearchText="_searchText"
                  @bind-ShowFilters="_showFilters"
                  @bind-ShowProgression="_showProgression"
                  @bind-SelectedRoot="_selectedRoot"
                  @bind-SelectedType="_selectedType"
                  @bind-SelectedDifficulty="_selectedDifficulty"
                  @bind-SelectedTags="_selectedTags"
                  OnFiltersChanged="ApplyFilters" />

    @if (_showProgression)
    {
        <ChordProgressionBuilder Chords="_progressionChords"
                                @bind-Tempo="_tempo"
                                IsPlaying="PlayerService.IsPlaying"
                                CurrentChordIndex="PlayerService.CurrentChordIndex"
                                OnTogglePlayback="TogglePlayback"
                                OnClearProgression="ClearProgression"
                                OnSaveProgression="SaveProgression"
                                OnShuffleProgression="ShuffleProgression"
                                OnShowTemplates="ShowTemplates"
                                OnShowSavedProgressions="ShowSavedProgressions"
                                OnRemoveChord="RemoveFromProgression" />
    }

    @if (_filteredChords.Any())
    {
        <div class="d-flex justify-space-between align-center mb-3">
            <MudText Typo="Typo.h5">
                @(string.IsNullOrEmpty(_searchText) ? "Popular Chords" : $"Results for \"{_searchText}\"")
                <MudChip T="string" Text="@_filteredChords.Count.ToString()" Size="Size.Small" Color="Color.Primary" />
            </MudText>
            <MudButtonGroup Variant="Variant.Text" Size="Size.Small">
                <MudIconButton Icon="@Icons.Material.Filled.GridView" 
                             Color="@(_viewMode == "grid" ? Color.Primary : Color.Default)"
                             OnClick="@(() => _viewMode = "grid")" />
                <MudIconButton Icon="@Icons.Material.Filled.ViewList" 
                             Color="@(_viewMode == "list" ? Color.Primary : Color.Default)"
                             OnClick="@(() => _viewMode = "list")" />
            </MudButtonGroup>
        </div>
        
        @if (_viewMode == "grid")
        {
            <MudGrid>
                @foreach (var chord in _filteredChords)
                {
                    <MudItem xs="12" sm="6" md="4" lg="3">
                        <ChordCard Chord="chord"
                                  ShowProgressionButton="_showProgression"
                                  IsFavorite="_favoriteChords.Contains(chord.Name)"
                                  Difficulty="@GetDifficulty(chord)"
                                  DifficultyColor="@GetDifficultyColor(chord)"
                                  OnClick="@(() => SelectChord(chord))"
                                  OnAddToProgression="AddToProgression"
                                  OnToggleFavorite="ToggleFavorite" />
                    </MudItem>
                }
            </MudGrid>
        }
        else
        {
            <MudList T="GuitarChord">
                @foreach (var chord in _filteredChords)
                {
                    <MudListItem T="GuitarChord" Value="chord" OnClick="() => SelectChord(chord)">
                        <div class="d-flex align-center">
                            <MudText Class="mr-4">@chord.Name</MudText>
                            <MudChip T="string" Text="@GetDifficulty(chord)" Size="Size.Small" Color="@(GetDifficultyColor(chord))" />
                            <MudSpacer />
                            @if (_showProgression)
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.Add" 
                                             Color="Color.Primary" 
                                             Size="Size.Small"
                                             OnClick="@(() => AddToProgression(chord))" />
                            }
                            <MudIconButton Icon="@(_favoriteChords.Contains(chord.Name) ? Icons.Material.Filled.Favorite : Icons.Material.Filled.FavoriteBorder)" 
                                         Color="@(_favoriteChords.Contains(chord.Name) ? Color.Error : Color.Default)"
                                         Size="Size.Small"
                                         OnClick="@(() => ToggleFavorite(chord))" />
                        </div>
                    </MudListItem>
                }
            </MudList>
        }
    }
    else if (!string.IsNullOrEmpty(_searchText))
    {
        <MudAlert Severity="Severity.Info">
            No chords found matching "@_searchText". Try adjusting your filters or search terms.
        </MudAlert>
    }

    <ChordDetailsDialog Chord="_selectedChord"
                       @bind-IsVisible="_showChordDialog"
                       ShowProgressionButton="_showProgression"
                       IsFavorite="@(_selectedChord != null && _favoriteChords.Contains(_selectedChord.Name))"
                       Difficulty="@(_selectedChord != null ? GetDifficulty(_selectedChord) : "")"
                       DifficultyColor="@(_selectedChord != null ? GetDifficultyColor(_selectedChord) : Color.Default)"
                       OnAddToProgression="AddToProgression"
                       OnToggleFavorite="ToggleFavorite" />
    
    @* Template Selection Dialog *@
    <MudDialog @bind-Visible="_showTemplateDialog" Options="_dialogOptions">
        <TitleContent>
            <MudText Typo="Typo.h6">Choose a Chord Progression Template</MudText>
        </TitleContent>
        <DialogContent>
            <MudList T="string">
                @foreach (var template in ProgressionService.GetCommonProgressions())
                {
                    <MudListItem T="string" OnClick="() => LoadTemplate(template.Key, template.Value)">
                        <MudText Typo="Typo.subtitle1">@template.Key</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">@string.Join(" - ", template.Value)</MudText>
                    </MudListItem>
                    <MudDivider />
                }
            </MudList>
        </DialogContent>
        <DialogActions>
            <MudButton Color="Color.Default" OnClick="@(() => _showTemplateDialog = false)">Cancel</MudButton>
        </DialogActions>
    </MudDialog>
    
    @* Save Progression Dialog *@
    <MudDialog @bind-Visible="_showSaveDialog" Options="_dialogOptions">
        <TitleContent>
            <MudText Typo="Typo.h6">Save Chord Progression</MudText>
        </TitleContent>
        <DialogContent>
            <MudTextField @bind-Value="_progressionName" Label="Progression Name" 
                         Variant="Variant.Outlined" Immediate="true" />
            <MudText Typo="Typo.body2" Class="mt-2">
                Chords: @string.Join(" - ", _progressionChords.Select(c => c.Name))
            </MudText>
            <MudText Typo="Typo.body2">
                Tempo: @_tempo BPM
            </MudText>
        </DialogContent>
        <DialogActions>
            <MudButton Color="Color.Default" OnClick="@(() => _showSaveDialog = false)">Cancel</MudButton>
            <MudButton Color="Color.Primary" OnClick="ConfirmSaveProgression">Save</MudButton>
        </DialogActions>
    </MudDialog>
    
    @* Saved Progressions Dialog *@
    <MudDialog @bind-Visible="_showSavedProgressionsDialog" Options="_dialogOptions">
        <TitleContent>
            <MudText Typo="Typo.h6">Saved Progressions</MudText>
        </TitleContent>
        <DialogContent>
            @if (ProgressionService.GetSavedProgressions().Any())
            {
                <MudList T="Services.ChordProgression">
                    @foreach (var progression in ProgressionService.GetSavedProgressions().OrderByDescending(p => p.CreatedDate))
                    {
                        <MudListItem T="Services.ChordProgression">
                            <div class="d-flex justify-space-between align-center">
                                <div @onclick="() => LoadSavedProgression(progression)" style="cursor: pointer; flex: 1;">
                                    <MudText Typo="Typo.subtitle1">@progression.Name</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                        @string.Join(" - ", progression.ChordNames) (@progression.Tempo BPM)
                                    </MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Tertiary">
                                        @progression.CreatedDate.ToString("MMM dd, yyyy HH:mm")
                                    </MudText>
                                </div>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                             Color="Color.Error" 
                                             Size="Size.Small"
                                             OnClick="@(() => DeleteSavedProgression(progression))" />
                            </div>
                        </MudListItem>
                        <MudDivider />
                    }
                </MudList>
            }
            else
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    No saved progressions yet. Create and save your first progression!
                </MudText>
            }
        </DialogContent>
        <DialogActions>
            <MudButton Color="Color.Default" OnClick="@(() => _showSavedProgressionsDialog = false)">Close</MudButton>
        </DialogActions>
    </MudDialog>
</MudContainer>

@code {
    private List<GuitarChord> _allChords = new();
    private List<GuitarChord> _filteredChords = new();
    private GuitarChord? _selectedChord;
    private string _selectedRoot = "";
    private string _selectedType = "";
    private string _selectedDifficulty = "";
    private string _searchText = "";
    private string _viewMode = "grid";
    private bool _showFilters;
    private bool _showProgression;
    private bool _showChordDialog;
    private bool _showTemplateDialog;
    private bool _showSaveDialog;
    private bool _showSavedProgressionsDialog;
    private string _progressionName = "";
    private int _tempo = 120;
    
    private IReadOnlyCollection<string> _selectedTags = new HashSet<string>();
    private HashSet<string> _favoriteChords = new();
    private List<GuitarChord> _progressionChords = new();
    
    private DialogOptions _dialogOptions = new()
    {
        MaxWidth = MaxWidth.Medium,
        FullWidth = true,
        CloseButton = true,
        Position = DialogPosition.Center
    };

    protected override void OnInitialized()
    {
        _allChords = ChordService.GetAllChords().ToList();
        ApplyFilters();
        
        // Subscribe to player events
        PlayerService.ChordChanged += OnChordChanged;
        PlayerService.PlaybackStarted += OnPlaybackStarted;
        PlayerService.PlaybackStopped += OnPlaybackStopped;
    }

    private void ApplyFilters()
    {
        _filteredChords = _allChords.Where(c => 
        {
            // Search text filter
            if (!string.IsNullOrEmpty(_searchText))
            {
                if (!c.Name.Contains(_searchText, StringComparison.OrdinalIgnoreCase))
                    return false;
            }
            
            // Root note filter
            if (!string.IsNullOrEmpty(_selectedRoot))
            {
                var chordRoot = c.Chord.Root.Name.ToString();
                if (!chordRoot.Equals(_selectedRoot, StringComparison.OrdinalIgnoreCase))
                    return false;
            }
            
            // Chord type filter
            if (!string.IsNullOrEmpty(_selectedType))
            {
                var chordType = c.Chord.Type.ToString();
                if (!chordType.Equals(_selectedType, StringComparison.OrdinalIgnoreCase))
                    return false;
            }
            
            // Difficulty filter
            if (!string.IsNullOrEmpty(_selectedDifficulty))
            {
                var difficulty = GetDifficulty(c);
                if (!difficulty.Equals(_selectedDifficulty, StringComparison.OrdinalIgnoreCase))
                    return false;
            }
            
            // Tag filters
            var tags = _selectedTags as HashSet<string> ?? _selectedTags.ToHashSet();
            if (tags.Contains("Open") && !IsOpenChord(c))
                return false;
            if (tags.Contains("Barre") && !c.IsBarreChord)
                return false;
            if (tags.Contains("Common") && !IsCommonChord(c))
                return false;
                
            return true;
        }).ToList();
    }

    private void SelectChord(GuitarChord chord)
    {
        _selectedChord = chord;
        _showChordDialog = true;
    }

    private string GetDifficulty(GuitarChord chord)
    {
        if (chord.IsBarreChord)
            return "Advanced";
        
        var fingersUsed = chord.Fingerings.Count(f => f > 0);
        if (fingersUsed <= 2)
            return "Beginner";
        else if (fingersUsed <= 3)
            return "Intermediate";
        else
            return "Advanced";
    }

    private Color GetDifficultyColor(GuitarChord chord)
    {
        return GetDifficulty(chord) switch
        {
            "Beginner" => Color.Success,
            "Intermediate" => Color.Warning,
            "Advanced" => Color.Error,
            _ => Color.Default
        };
    }

    private bool IsOpenChord(GuitarChord chord)
    {
        return chord is { BaseFret: 0, IsBarreChord: false };
    }

    private bool IsCommonChord(GuitarChord chord)
    {
        var commonChordNames = new[] { "C", "G", "D", "A", "E", "F", "Am", "Em", "Dm", "G7", "C7", "D7", "A7", "E7" };
        return commonChordNames.Contains(chord.Name);
    }

    private void ToggleFavorite(GuitarChord chord)
    {
        if (_favoriteChords.Contains(chord.Name))
            _favoriteChords.Remove(chord.Name);
        else
            _favoriteChords.Add(chord.Name);
    }

    private void AddToProgression(GuitarChord chord)
    {
        if (!_progressionChords.Contains(chord))
        {
            _progressionChords.Add(chord);
            Snackbar.Add($"Added {chord.Name} to progression", Severity.Success);
        }
    }

    private void RemoveFromProgression(GuitarChord chord)
    {
        _progressionChords.Remove(chord);
    }

    private void ClearProgression()
    {
        _progressionChords.Clear();
        PlayerService.StopPlayback();
    }

    private void ShuffleProgression()
    {
        var random = new Random();
        _progressionChords = _progressionChords.OrderBy(x => random.Next()).ToList();
    }

    private async Task TogglePlayback()
    {
        if (PlayerService.IsPlaying)
        {
            PlayerService.StopPlayback();
        }
        else
        {
            await PlayerService.PlayProgressionAsync(_progressionChords, _tempo);
        }
    }

    private void ShowTemplates()
    {
        _showTemplateDialog = true;
    }

    private void ShowSavedProgressions()
    {
        _showSavedProgressionsDialog = true;
    }

    private void SaveProgression()
    {
        _showSaveDialog = true;
        _progressionName = $"Progression {DateTime.Now:yyyy-MM-dd HH:mm}";
    }

    private void ConfirmSaveProgression()
    {
        if (!string.IsNullOrWhiteSpace(_progressionName))
        {
            var chordNames = _progressionChords.Select(c => c.Name).ToList();
            ProgressionService.SaveProgression(_progressionName, chordNames, _tempo);
            Snackbar.Add($"Saved progression: {_progressionName}", Severity.Success);
            _showSaveDialog = false;
            _progressionName = "";
        }
    }

    private void LoadTemplate(string templateName, List<string> chordNames)
    {
        _progressionChords.Clear();
        foreach (var chordName in chordNames)
        {
            var chord = _allChords.FirstOrDefault(c => c.Name == chordName);
            if (chord != null)
            {
                _progressionChords.Add(chord);
            }
        }
        _showTemplateDialog = false;
        Snackbar.Add($"Loaded template: {templateName}", Severity.Info);
    }

    private void LoadSavedProgression(Services.ChordProgression progression)
    {
        _progressionChords.Clear();
        foreach (var chordName in progression.ChordNames)
        {
            var chord = _allChords.FirstOrDefault(c => c.Name == chordName);
            if (chord != null)
            {
                _progressionChords.Add(chord);
            }
        }
        _tempo = progression.Tempo;
        _showSavedProgressionsDialog = false;
        Snackbar.Add($"Loaded progression: {progression.Name}", Severity.Info);
    }

    private void DeleteSavedProgression(Services.ChordProgression progression)
    {
        ProgressionService.DeleteProgression(progression.Id);
        Snackbar.Add($"Deleted progression: {progression.Name}", Severity.Warning);
    }

    private void OnChordChanged(int index)
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnPlaybackStarted()
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnPlaybackStopped()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        PlayerService.ChordChanged -= OnChordChanged;
        PlayerService.PlaybackStarted -= OnPlaybackStarted;
        PlayerService.PlaybackStopped -= OnPlaybackStopped;
        PlayerService.StopPlayback();
    }
}