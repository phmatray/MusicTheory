@using GuitarChords.Services
@using GuitarChords.Models
@inject GuitarAudioService AudioService

<MudPaper Class="pa-4" Elevation="1">
    <MudText Typo="Typo.h6" Class="mb-3">
        <MudIcon Icon="@Icons.Material.Filled.VolumeUp" Class="mr-2" />
        Audio Settings
    </MudText>

    @* Volume Control *@
    <div class="mb-4">
        <MudText Typo="Typo.subtitle2" Class="mb-2">Master Volume</MudText>
        <div class="d-flex align-center gap-2">
            <MudIcon Icon="@GetVolumeIcon()" Size="Size.Small" />
            <MudSlider T="double"
                      Value="_volume"
                      ValueChanged="HandleVolumeChanged"
                      Min="0"
                      Max="1"
                      Step="0.05"
                      Color="Color.Primary"
                      Class="flex-grow-1" />
            <MudText Typo="Typo.body2" Style="min-width: 40px;">@((_volume * 100).ToString("0"))%</MudText>
        </div>
    </div>

    @* Strumming Pattern Selector *@
    <div class="mb-4">
        <MudText Typo="Typo.subtitle2" Class="mb-2">Strumming Pattern</MudText>
        <MudSelect T="string"
                  Value="_selectedPattern"
                  ValueChanged="OnPatternChanged"
                  Label="Select Pattern"
                  Variant="Variant.Outlined"
                  Dense="true">
            @foreach (var pattern in _patterns)
            {
                <MudSelectItem Value="@pattern.Id">
                    @pattern.Name
                </MudSelectItem>
            }
        </MudSelect>

        @if (!string.IsNullOrEmpty(_selectedPattern))
        {
            var pattern = _patterns.FirstOrDefault(p => p.Id == _selectedPattern);
            @if (pattern != null)
            {
                <MudText Typo="Typo.caption" Class="mt-2" Color="Color.Secondary">
                    Pattern: @FormatPattern(pattern.Pattern)
                </MudText>
            }
        }
    </div>

    @* Tempo Control *@
    <div class="mb-4">
        <MudText Typo="Typo.subtitle2" Class="mb-2">Tempo (BPM)</MudText>
        <div class="d-flex align-center gap-2">
            <MudIconButton Icon="@Icons.Material.Filled.Remove"
                          Size="Size.Small"
                          OnClick="() => AdjustTempo(-5)"
                          Disabled="@(_tempo <= 40)" />
            <MudSlider T="int"
                      @bind-Value="_tempo"
                      Min="40"
                      Max="200"
                      Step="1"
                      Color="Color.Secondary"
                      Class="flex-grow-1" />
            <MudIconButton Icon="@Icons.Material.Filled.Add"
                          Size="Size.Small"
                          OnClick="() => AdjustTempo(5)"
                          Disabled="@(_tempo >= 200)" />
            <MudText Typo="Typo.body2" Style="min-width: 50px;">@_tempo BPM</MudText>
        </div>
    </div>

    @* Preview Button *@
    @if (PreviewChord != null)
    {
        <MudButton Variant="Variant.Filled"
                  Color="Color.Primary"
                  StartIcon="@Icons.Material.Filled.PlayArrow"
                  OnClick="PlayPreview"
                  Disabled="_isPlaying"
                  FullWidth="true">
            @if (_isPlaying)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                @:Playing...
            }
            else
            {
                @:Preview Strumming Pattern
            }
        </MudButton>
    }
</MudPaper>

@code {
    [Parameter]
    public GuitarChord? PreviewChord { get; set; }

    [Parameter]
    public EventCallback<string> OnPatternSelected { get; set; }

    [Parameter]
    public EventCallback<int> OnTempoChanged { get; set; }

    [Parameter]
    public EventCallback<double> VolumeChanged { get; set; }

    private double _volume = 0.7;
    private string _selectedPattern = "folk";
    private int _tempo = 120;
    private bool _isPlaying;
    private List<StrummingPattern> _patterns = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _patterns = await AudioService.GetStrummingPatternsAsync();
            _volume = await AudioService.GetMasterVolumeAsync();
        }
        catch
        {
            // Audio may not be initialized
            _patterns = GetDefaultPatterns();
        }
    }

    private List<StrummingPattern> GetDefaultPatterns()
    {
        return new List<StrummingPattern>
        {
            new() { Id = "basic-4", Name = "Basic 4/4", Pattern = "D...D...D...D...", BeatsPerMeasure = 4 },
            new() { Id = "folk", Name = "Folk", Pattern = "D.DU.UDU", BeatsPerMeasure = 4 },
            new() { Id = "pop-rock", Name = "Pop Rock", Pattern = "D.DU.UDU", BeatsPerMeasure = 4 },
            new() { Id = "country", Name = "Country", Pattern = "D..D.U.U", BeatsPerMeasure = 4 },
            new() { Id = "reggae", Name = "Reggae", Pattern = ".D.U.D.U", BeatsPerMeasure = 4 },
            new() { Id = "ballad", Name = "Ballad 6/8", Pattern = "D..D.U", BeatsPerMeasure = 6 },
            new() { Id = "waltz", Name = "Waltz 3/4", Pattern = "D..D.U", BeatsPerMeasure = 3 }
        };
    }

    private async Task HandleVolumeChanged(double volume)
    {
        _volume = volume;
        try
        {
            await AudioService.SetMasterVolumeAsync(volume);
            await VolumeChanged.InvokeAsync(volume);
        }
        catch
        {
            // Audio may not be initialized
        }
    }

    private async Task OnPatternChanged(string patternId)
    {
        _selectedPattern = patternId;
        await OnPatternSelected.InvokeAsync(patternId);
    }

    private void AdjustTempo(int delta)
    {
        _tempo = Math.Clamp(_tempo + delta, 40, 200);
        OnTempoChanged.InvokeAsync(_tempo);
    }

    private async Task PlayPreview()
    {
        if (PreviewChord == null || _isPlaying) return;

        _isPlaying = true;
        StateHasChanged();

        try
        {
            await AudioService.PlayStrummingPatternAsync(PreviewChord, _selectedPattern, _tempo, 2);
        }
        catch
        {
            // Audio error
        }
        finally
        {
            _isPlaying = false;
            StateHasChanged();
        }
    }

    private string GetVolumeIcon()
    {
        return _volume switch
        {
            0 => Icons.Material.Filled.VolumeOff,
            < 0.3 => Icons.Material.Filled.VolumeMute,
            < 0.7 => Icons.Material.Filled.VolumeDown,
            _ => Icons.Material.Filled.VolumeUp
        };
    }

    private string FormatPattern(string pattern)
    {
        return pattern
            .Replace("D", "↓")
            .Replace("U", "↑")
            .Replace("x", "x")
            .Replace(".", "·");
    }
}
